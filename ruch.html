<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>PixiJS Drag and Drops</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- <style>
        /* Basic CSS for modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #b9f5ee;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            text-align: center;
        }

        .modal-content button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }

        .close {
            color: #0a0a0a;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style> -->
</head>

<body>
    <h1 style="text-align: center;">Join the Horse's body</h1>
    <div id="retryModal" class="modal">
        <div class="modal-content">
            <span class="close" id="retryClose">&times;</span>
            <p>Do you want to retry?</p>
            <button id="retryButton">Retry</button>
        </div>
    </div>
    <div id="nextModal" class="modal">
        <div class="modal-content">
            <span class="close" id="nextClose">&times;</span>
            <p>Congratulations! Ready for the next level?</p>
            <p id="timeTakenText">Time Taken: </p>
            <button id="nextButton">Next Level</button>
            <button id="retryLevelButton">Retry Level</button>
        </div>
    </div>
    <div id="timer" style="text-align: center;"></div>
    <script type="text/javascript">
        // The application
        window.onload = function () {
            var app = new PIXI.Application({
                width: 1500,
                height: 600,
                backgroundColor: 0xFFFFFF
            });

            // Add application to the DOM
            document.body.appendChild(app.view);

            // Load the images
            app.loader
                .add('image1', 'horse1.png')
                .add('image2', 'horse2.png')
                .add('shad', 'horseshad.png')
                .add('deer', 'deerhead.png')
                .load(setup);

            // Variables to store the images
            var image1, image2, shad, deer;

            // Initial positions for the images
            var initialPositions = {
                image1: { x: 1100, y: 280 },
                image2: { x: 725, y: 100 },
                shad: { x: 400, y: 100 },
                deer: { x: 1200, y: 0 }
            };

            // Timer variables
            var startTime, endTime, timerInterval;///////////////////////////////

            function setup() {
                // Create sprites from the loaded images
                image1 = new PIXI.Sprite(app.loader.resources['image1'].texture);
                image2 = new PIXI.Sprite(app.loader.resources['image2'].texture);
                shad = new PIXI.Sprite(app.loader.resources['shad'].texture);
                deer = new PIXI.Sprite(app.loader.resources['deer'].texture);

                // Set initial positions
                image1.position.set(initialPositions.image1.x, initialPositions.image1.y);
                image2.position.set(initialPositions.image2.x, initialPositions.image2.y);
                shad.position.set(initialPositions.shad.x, initialPositions.shad.y);
                deer.position.set(initialPositions.deer.x, initialPositions.deer.y);

                // Enable interactivity
                image1.interactive = true;
                deer.interactive = true;

                // Set up events for dragging
                image1
                    .on('mousedown', onDragStart)
                    .on('mousemove', onDragMove)
                    .on('mouseup', onDragEnd)
                    .on('mouseupoutside', onDragEnd);

                deer
                    .on('mousedown', onDragStart)
                    .on('mousemove', onDragMove)
                    .on('mouseup', onDeerDragEnd)
                    .on('mouseupoutside', onDeerDragEnd);

                // Add images to the stage
                app.stage.addChild(shad);
                app.stage.addChild(image1);
                app.stage.addChild(image2);
                app.stage.addChild(deer);

                // Start the timer
                startTime = new Date();
                timerInterval = setInterval(updateTimer, 1000);//////////////////////////////////

                // Set up retry modal
                var retryModal = document.getElementById('retryModal');
                var retryButton = document.getElementById('retryButton');
                var retryClose = document.getElementById('retryClose');

                retryButton.onclick = function () {
                    resetPositions();
                    retryModal.style.display = 'none';
                };
                retryClose.onclick = function () {
                    retryModal.style.display = 'none';
                };
                window.onclick = function (event) {
                    if (event.target == retryModal) {
                        retryModal.style.display = 'none';
                    }
                };

                // Set up next level modal
                var nextModal = document.getElementById('nextModal');
                var nextButton = document.getElementById('nextButton');
                var retryLevelButton = document.getElementById('retryLevelButton');
                var nextClose = document.getElementById('nextClose');

                nextButton.onclick = function () {
                    endTime = new Date();
                    clearInterval(timerInterval); // Stop the timer
                    var timeTaken = (endTime - startTime) / 1000; // Calculate time taken in seconds
                    window.location.href = '4part.html'; // Change URL to next level
                };
                retryLevelButton.onclick = function () {
                    resetPositions();
                    clearInterval(timerInterval); // Stop the timer
                    startTime = new Date(); // Reset the start time
                    timerInterval = setInterval(updateTimer, 1000); // Restart the timer
                    nextModal.style.display = 'none';
                };

                nextClose.onclick = function () {
                    nextModal.style.display = 'none';
                };
                window.onclick = function (event) {
                    if (event.target == nextModal) {
                        nextModal.style.display = 'none';
                    }
                };
            }

            // Update timer function
            function updateTimer() {
                var currentTime = new Date();
                var timeDiff = currentTime - startTime;
                var seconds = Math.floor(timeDiff / 1000);
                var minutes = Math.floor(seconds / 60);
                seconds %= 60;

                // Display timer in the format MM:SS
                document.getElementById('timer').textContent = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            }

            // Drag functions
            function onDragStart(event) {
                this.data = event.data;
                this.dragging = true;
                var newPosition = this.data.getLocalPosition(this.parent);
                this.offset = new PIXI.Point(newPosition.x - this.x, newPosition.y - this.y);
            }

            function onDragMove() {
                if (this.dragging) {
                    var newPosition = this.data.getLocalPosition(this.parent);
                    this.position.set(newPosition.x - this.offset.x, newPosition.y - this.offset.y);
                }
            }

            function onDragEnd() {
                this.dragging = false;
                this.data = null;

                // Check if images are in a specific position for completion
                if (Math.abs(image1.x - 400) < 10 && Math.abs(image1.y - 100) < 10 &&
                    Math.abs(image2.x - 725) < 10 && Math.abs(image2.y - 100) < 10) {
                    // Trigger confetti effect
                    confetti();

                    // Stop the timer
                    clearInterval(timerInterval);

                    // Show next level modal
                    var nextModal = document.getElementById('nextModal');
                    var endTime = new Date(); // Capture end time
                    var timeTaken = (endTime - startTime) / 1000; // Calculate time taken in seconds
                    var minutes = Math.floor(timeTaken / 60);
                    var seconds = Math.floor(timeTaken % 60);
                    var formattedTime = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    document.getElementById('timeTakenText').textContent = 'Time Taken: ' + formattedTime;
                    nextModal.style.display = 'block';
                } else {
                    // Reset to initial position if not correct
                    this.position.set(initialPositions[this.texture.textureCacheIds[0]].x, initialPositions[this.texture.textureCacheIds[0]].y);
                }
            }

            // Drag function for deer
            function onDeerDragEnd() {
                this.dragging = false;
                this.data = null;

                // Reset deer to its initial position
                this.position.set(initialPositions.deer.x, initialPositions.deer.y);
            }

            // Function to reset positions
            function resetPositions() {
                image1.position.set(initialPositions.image1.x, initialPositions.image1.y);
                image2.position.set(initialPositions.image2.x, initialPositions.image2.y);
                shad.position.set(initialPositions.shad.x, initialPositions.shad.y);
                deer.position.set(initialPositions.deer.x, initialPositions.deer.y);
            }
        };
    </script>
</body>

</html>